name: DEV ENG Deploy

on:
  push:
    branches: [ "dev" ]
  workflow_dispatch:

env:
  DOCKER_BUILD_VERSION: "1.0"
  DOCKER_IMAGE_NAME: "repasscloud/optechx.stripe.api.dev"

jobs:
  dev-eng-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 🛒 Checkout
        uses: actions/checkout@v3

      - name: 🔑 Create SSH Key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: 🔑 Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DH_USERID }}
          password: ${{ secrets.DH_TOKEN }}

      - name: 🔐 Decrypt Repo
        run: ./decrypt_repo.sh
        env:
          LARGE_SECRET_PASSPHRASE: ${{ secrets.LARGE_SECRET_PHRASE }}
        shell: bash

      - name: 🐳🏗️ Docker DEV ENG Build
        run: |
          docker build --rm --no-cache --tag "$DOCKER_IMAGE_NAME:$DOCKER_BUILD_VERSION" --file Dockerfile .
          docker tag "$DOCKER_IMAGE_NAME:$DOCKER_BUILD_VERSION" "$DOCKER_IMAGE_NAME"

      - name: 🚀🐳 Publish to Docker Hub
        run: |
          docker image push "$DOCKER_IMAGE_NAME:$DOCKER_BUILD_VERSION"
          docker image push "$DOCKER_IMAGE_NAME"

      - name: 🖥️ Deploy to DEV-ENG Environment
        env:
          SSH_USER: ${{ secrets.DEV_ENG_AU_OPTECHX_DATA_SSH_USER }}
          SSH_URL: ${{ secrets.DEV_ENG_AU_OPTECHX_DATA_URL }}
        run: |
          chmod +x ./deploy.sh
          ./deploy.sh
        shell: bash

      - name: 🗑️ Cleanup
        run: |
          rm -rf ./app
          rm -rf ./lib


  if_error_or_failure:
    runs-on: ubuntu-latest
    if: >-
      github.event.state == 'error' ||
      github.event.state == 'failure'
    steps:
      - env:
          DESCRIPTION: ${{ github.event.description }}
        run: |
          echo The status is error or failed: $DESCRIPTION
